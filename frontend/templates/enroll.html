<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Enrollment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
<div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-xl p-8 bg-white rounded-xl shadow-2xl border-t-4 border-indigo-600">
        <h1 class="text-3xl font-bold text-center text-indigo-700">Course Enrollment</h1>
        <p class="text-center text-gray-500 mt-2 text-sm">Interacting with: <strong>Enrollment Service (Node 4)</strong> - Port 5003</p>

        <div id="statusMessage" class="mt-6 p-4 rounded-lg text-center font-medium hidden"></div>

        <div id="userInfo" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-sm text-blue-800">
                <strong>Logged in as:</strong> <span id="displayUsername">Loading...</span> (<span id="displayRole">Loading...</span>)
            </p>
            <p class="text-sm text-blue-600 mt-1">
                <strong>User ID:</strong> <span id="displayUserId">Loading...</span>
            </p>
        </div>

        <div class="mt-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200">
            <p class="text-lg font-semibold text-indigo-800 mb-4">Enroll in a Course</p>
            
            <form id="enrollmentForm" onsubmit="confirmEnrollment(event)">
                <div>
                    <label for="courseIdInput" class="block text-sm font-medium text-gray-700 mb-2">
                        Course ID <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="courseIdInput" 
                        placeholder="e.g., CS101, MATH203, ENG100" 
                        required 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm uppercase"
                    />
                    <p class="text-xs text-gray-500 mt-1">Enter the course ID you wish to enroll in</p>
                </div>

                <button 
                    type="submit" 
                    id="enrollBtn" 
                    class="mt-4 w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md hover:shadow-lg"
                >
                    Confirm Enrollment
                </button>
            </form>

            <p class="mt-4 text-xs text-indigo-600">
                Available courses: CS101, MATH203, ENG100, GERIZAL, GEETHIC
            </p>
        </div>
        
        <div class="mt-8 p-6 bg-gray-100 rounded-lg border border-gray-300">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Your Current Enrollments</h2>
            <div id="enrollmentsList" class="space-y-3">
                <p id="loadingEnrollments" class="text-sm text-gray-500">Loading enrollments...</p>
                </div>
        </div>
        <div class="mt-6 flex flex-col space-y-3">
            <a href="/courses" class="text-center text-sm text-gray-600 hover:text-gray-800 font-medium">
                &larr; Back to Course Catalog
            </a>
        </div>
    </div>
</div>

<script>
    const enrollmentServiceUrl = 'http://localhost:5001/api/v1/enroll/course';
    const enrollmentsApiUrl = 'http://localhost:5001/api/v1/enroll/student'; // Updated to match REST Gateway
    const dropCourseApiUrl = 'http://localhost:5001/api/v1/enroll/drop'; // New drop endpoint
    
    // Get parameters from URL (if redirected from courses page)
    const urlParams = new URLSearchParams(window.location.search);
    const prefilledCourseId = urlParams.get('course_id');

    function showStatus(message, type = 'info') {
        const el = document.getElementById('statusMessage');
        el.textContent = message;
        el.className = 'mt-6 p-4 rounded-lg text-center font-medium block';
        
        if (type === 'success') {
            el.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            el.classList.add('bg-red-100', 'text-red-800');
        } else {
            el.classList.add('bg-blue-100', 'text-blue-800');
        }
        el.classList.remove('hidden');
    }

    function hideStatus() {
        const el = document.getElementById('statusMessage');
        el.classList.add('hidden');
    }

    function getToken() {
        return localStorage.getItem('user_jwt_token');
    }

    function getRole() {
        return localStorage.getItem('user_role');
    }

    function getUserId() {
        return localStorage.getItem('user_id');
    }

    // New: Function to load and display enrolled courses
    async function loadStudentEnrollments() {
        const token = getToken();
        const enrollmentsListEl = document.getElementById('enrollmentsList');
        enrollmentsListEl.innerHTML = '<p id="loadingEnrollments" class="text-sm text-gray-500">Loading enrollments...</p>';

        if (!token) {
            enrollmentsListEl.innerHTML = '<p class="text-sm text-red-500">Cannot load enrollments. Please log in.</p>';
            return;
        }

        try {
            const response = await fetch(enrollmentsApiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                data = { message: response.statusText, enrollments: [] };
            }

            if (response.ok && data.status === 'success') {
                const enrollments = data.enrollments || [];
                
                if (enrollments.length === 0) {
                    enrollmentsListEl.innerHTML = '<p class="text-sm text-gray-500">You are not currently enrolled in any courses.</p>';
                    return;
                }

                enrollmentsListEl.innerHTML = ''; // Clear loading message

                enrollments.forEach(enrollment => {
                    const date = new Date(enrollment.enrollment_date).toLocaleDateString();
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                    item.innerHTML = `
                        <div>
                            <p class="text-sm font-medium text-gray-900">${enrollment.course_name} (${enrollment.course_id})</p>
                            <p class="text-xs text-gray-500 mt-0.5">Enrolled on: ${date}</p>
                        </div>
                        <button 
                            onclick="dropCourse('${enrollment.course_id}', '${enrollment.course_name}')"
                            class="py-1 px-3 bg-red-500 text-white text-xs font-semibold rounded hover:bg-red-600 transition duration-150"
                        >
                            Drop
                        </button>
                    `;
                    enrollmentsListEl.appendChild(item);
                });
            } else {
                enrollmentsListEl.innerHTML = `<p class="text-sm text-red-500">Error loading enrollments: ${data.message || 'Unknown error'}</p>`;
            }

        } catch (error) {
            console.error('Enrollments network error:', error);
            enrollmentsListEl.innerHTML = '<p class="text-sm text-red-500">Network error: Could not connect to enrollment service. Make sure the REST Gateway is running.</p>';
        }
    }

    // New: Function to handle course dropping
    async function dropCourse(courseId, courseName) {
        if (!confirm(`Are you sure you want to drop the course: ${courseName} (${courseId})? This action cannot be undone.`)) {
            return;
        }

        const token = getToken();
        if (!token) {
            showStatus('Authentication required. Please log in.', 'error');
            setTimeout(() => { window.location.href = '/auth.html'; }, 2000);
            return;
        }
        
        showStatus(`Processing drop request for ${courseId}...`, 'info');

        try {
            const response = await fetch(`${dropCourseApiUrl}/${encodeURIComponent(courseId)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                data = { message: response.statusText };
            }
            
            if (response.ok) {
                showStatus(`✓ ${data.message || 'Course dropped successfully.'}`, 'success');
                // Reload the enrollments list after a successful drop
                loadStudentEnrollments();
                // Clear the enrollment form input if it matches the dropped course
                if (document.getElementById('courseIdInput').value.trim().toUpperCase() === courseId) {
                    document.getElementById('courseIdInput').value = '';
                }
            } else {
                showStatus(`Drop failed: ${data.message || 'Unknown error'}`, 'error');
            }

        } catch (error) {
            console.error('Drop network error:', error);
            showStatus('Network error: Could not reach Enrollment Service.', 'error');
        }
    }


    // Check if user is logged in and is a student on page load
    window.addEventListener('DOMContentLoaded', () => {
        const token = getToken();
        const role = getRole();
        const userId = getUserId();

        // Display user info if available
        document.getElementById('displayUserId').textContent = userId || 'Not available';
        document.getElementById('displayRole').textContent = role || 'Unknown';
        document.getElementById('displayUsername').textContent = 'User'; // You can store username too if needed

        if (!token) {
            showStatus('You must be logged in to enroll. Redirecting to login...', 'error');
            setTimeout(() => {
                window.location.href = '/auth.html';
            }, 2000);
            return;
        }

        if (role !== 'student') {
            showStatus(`Only students can enroll and drop. Your role is "${role}". Redirecting...`, 'error');
            document.getElementById('enrollBtn').disabled = true;
            document.getElementById('courseIdInput').disabled = true;
            setTimeout(() => {
                window.location.href = '/courses';
            }, 3000);
        } else {
            // New: Load enrollments only for students
            loadStudentEnrollments();
        }

        // Pre-fill course ID if coming from courses page
        if (prefilledCourseId) {
            document.getElementById('courseIdInput').value = prefilledCourseId.toUpperCase();
            showStatus(`Ready to enroll in ${prefilledCourseId}`, 'info');
        }
    });

    async function confirmEnrollment(event) {
        event.preventDefault();
        
        const token = getToken();
        const role = getRole();
        const courseId = document.getElementById('courseIdInput').value.trim().toUpperCase();
        const enrollBtn = document.getElementById('enrollBtn');

        if (!token) {
            showStatus('Authentication required. Please log in.', 'error');
            setTimeout(() => {
                window.location.href = '/auth.html';
            }, 2000);
            return;
        }

        if (role !== 'student') {
            showStatus(`Only students can enroll. Your role is "${role}".`, 'error');
            return;
        }

        if (!courseId) {
            showStatus('Please enter a valid Course ID.', 'error');
            return;
        }

        // Disable form and show loading state
        enrollBtn.disabled = true;
        enrollBtn.textContent = 'Processing...';
        document.getElementById('courseIdInput').disabled = true;
        showStatus(`Submitting enrollment request for ${courseId}...`, 'info');

        try {
            const response = await fetch(`${enrollmentServiceUrl}/${encodeURIComponent(courseId)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                data = { message: response.statusText };
            }

            if (response.ok) {
                showStatus(`✓ ${data.message || 'Enrollment successful!'}`, 'success');
                // MODIFIED: Reload enrollments instead of redirecting
                loadStudentEnrollments();
                enrollBtn.disabled = false;
                enrollBtn.textContent = 'Confirm Enrollment';
                document.getElementById('courseIdInput').disabled = false;
            } else {
                // Re-enable form on error
                enrollBtn.disabled = false;
                enrollBtn.textContent = 'Confirm Enrollment';
                document.getElementById('courseIdInput').disabled = false;

                if (response.status === 503) {
                    showStatus(`Service Unavailable: ${data.message || 'Enrollment service or database is down'}`, 'error');
                } else if (response.status === 403) {
                    showStatus(`Access Denied: ${data.message || 'You do not have permission to enroll'}`, 'error');
                } else if (response.status === 401) {
                    showStatus('Authentication failed. Please log in again.', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/auth.html';
                    }, 2000);
                } else if (response.status === 400) {
                    showStatus(`${data.message || 'Invalid enrollment request'}`, 'error');
                } else if (response.status === 404) {
                    showStatus(`Course "${courseId}" not found. Please check the course ID.`, 'error');
                } else {
                    showStatus(`Enrollment failed: ${data.message || 'Unknown error'}`, 'error');
                }
            }

        } catch (error) {
            console.error('Enrollment network error:', error);
            showStatus('Network error: Could not reach Enrollment Service (Port 5003). The service may be down.', 'error');
            
            // Re-enable form
            enrollBtn.disabled = false;
            enrollBtn.textContent = 'Confirm Enrollment';
            document.getElementById('courseIdInput').disabled = false;
        }
    }
</script>
</body>
</html>